# Day 42: MLOps 進階 - Kubernetes, Drift Detection & CI/CD

## 0. 前言：從「寫完 Code」到「維運系統」
在 Day 29，我們學會了用 Streamlit 快速部署一個 Web App。但在真實的企業級應用中，這只是冰山一角。
當你的模型要服務 **百萬級用戶**，或者要確保模型 **三個月後還是一樣準**，你就需要 **MLOps (Machine Learning Operations)**。

本章節整理了 IPAS 考題中關於 **系統架構、維運監控、持續整合** 的進階知識。

## 1. 大規模部署：Kubernetes (K8s)
當一台伺服器撐不住流量時，我們需要「分身術」。

### 1.1 容器化與 K8s
*   **Docker (容器)**：把你的模型打包成一個標準化的便當盒 (Container)，到哪都能跑。
*   **Kubernetes (K8s)**：管理這些便當盒的 **指揮官**。
    *   **自動擴展 (Auto Scaling)**：流量大時，自動叫出 100 個模型分身；流量小時，縮減回 2 個 (省錢)。(考題 Q31)
    *   **負載平衡 (Load Balancing)**：把請求平均分給每個分身。
    *   **自我修復 (Self-healing)**：某個分身掛了，K8s 會自動重啟它。

### 1.2 部署策略 (Deployment Strategies)
*   **藍綠部署 (Blue-Green)**：新舊版本並存，測試沒問題後瞬間切換流量。
*   **金絲雀部署 (Canary Deployment)**：先讓 5% 用戶用新版，沒問題再慢慢擴大到 100%。(考題 Q23 - 漸進式部署)

## 2. 模型監控：Data Drift (資料漂移)
模型上線後，最怕的就是 **「模型沒變，但世界變了」**。

### 2.1 什麼是漂移？
*   **Data Drift (資料漂移)**：輸入資料的分佈變了。
    *   *例子*：原本訓練資料都是年輕人，突然來了一堆老年人用戶。
*   **Concept Drift (概念漂移)**：輸入與輸出的關係變了。
    *   *例子*：原本「刷卡買機票」是正常行為，疫情期間變成「異常行為」(因為沒人出國)。

### 2.2 如何偵測漂移？(考題重點)
我們需要數學指標來衡量「昨天」跟「今天」的資料長得像不像：
1.  **PSI (Population Stability Index)**：(考題 Q32)
    *   衡量兩個分佈差異的指標。
    *   PSI < 0.1：無顯著差異 (安全)。
    *   PSI > 0.25：差異顯著 (警報！需重新訓練)。
2.  **KL 散度 (KL Divergence)**：(考題 Q22)
    *   衡量兩個機率分佈 $P$ 和 $Q$ 的距離。
    *   值越小代表越像。
3.  **VAE 潛在空間監控**：(考題 Q42)
    *   對於高維度影像資料，直接比對像素很難。
    *   解法：用 VAE 把圖片壓縮成 Latent Vector，監控這個 Vector 的分佈變化。

## 3. MLOps 核心流程
### 3.1 Model Registry (模型註冊中心)
*   **問題**：你訓練了 100 個版本的模型，哪個是最好的？哪個是現在線上的？
*   **解法**：使用 **Model Registry** (如 MLflow)。(考題 Q15)
    *   集中管理所有版本 (v1.0, v1.1, v2.0)。
    *   標記狀態 (Staging, Production, Archived)。
    *   確保「不可否認性」與「可追溯性」。

### 3.2 CI/CD (持續整合/持續部署)
*   **CI (Continuous Integration)**：(考題 Q29)
    *   你一 Push 程式碼，系統 **自動** 跑單元測試、整合測試。
    *   確保新程式碼不會弄壞舊功能。
*   **CD (Continuous Deployment)**：
    *   測試通過後，**自動** 打包 Docker Image 並推送到 K8s。

## 4. 日誌與除錯
### 4.1 JSON 日誌處理
*   現代系統 (如 K8s, Microservices) 通常輸出 **JSON 格式** 的 Log。
*   **特徵提取**：(考題 Q27)
    *   需要將巢狀 (Nested) 的 JSON 欄位「展開 (Flatten)」。
    *   基於「時間窗口 (Time Window)」(例如每 5 分鐘) 進行聚合統計 (Count, Avg)。

## 5. IPAS 考題詳解 (MLOps 篇)
| 題目 (關鍵字) | 答案 | 解析 |
| :--- | :--- | :--- |
| **13. Kubernetes 功能** | (B) 管理模型服務的部署與擴展 | K8s 是容器編排標準，核心功能就是 Deployment & Scaling。 |
| **15. Model Registry 用途** | (C) 集中管理模型版本與部署狀態 | 避免「檔案總管管理法」(final_v1.h5, final_v2.h5...) 的混亂。 |
| **22. 資料漂移偵測** | (D) 計算 KL 散度 (KL Divergence) | 數學上衡量兩個分佈差異的標準方法。 |
| **23. 漸進式部署** | (A) 從單一專科開始，逐步擴展 | 類似金絲雀部署的概念，降低風險。 |
| **27. JSON 日誌特徵提取** | (C) 展開巢狀欄位並基於時間窗口聚合 | Log 資料通常是串流 (Streaming)，需做 Window Aggregation 才能變特徵。 |
| **29. CI 核心實踐** | (B) 提交後自動觸發建置與測試 | 自動化是 CI 的靈魂。 |
| **31. 高流量架構** | (B) 容器化部署並水平擴展 (Auto Scaling) | Scale Out (加機器) 比 Scale Up (換強機器) 更靈活且便宜。 |
| **32. 效能衰退預警** | (D) 輸入特徵分佈的 PSI 指數 | PSI 是銀行業/風控界最常用的漂移監控指標。 |
| **42. 新樣本分佈偏移** | (D) 使用 VAE 監控潛在空間分佈 | 針對非結構化資料 (影像) 的高階監控技巧。 |
| **46. MLOps 漂移偵測** | (A) 建立即時 Data/Concept Drift 監測 | 這是 MLOps 平台必備功能。 |

## 6. 總結
MLOps 是讓 AI 從「實驗室」走向「戰場」的關鍵。
*   **K8s** 讓模型能打十個 (擴展性)。
*   **Drift Detection** 讓模型不會老眼昏花 (監控)。
*   **CI/CD** 讓更新模型像喝水一樣自然 (自動化)。

下一章 (Day 43)，我們將探討 AI 時代最敏感的話題：**安全與隱私**。
當駭客試圖攻擊你的模型，或是法規要求保護個資時，該怎麼辦？
